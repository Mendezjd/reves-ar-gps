<!DOCTYPE html>
<html>
<head>
  <title>AR GPS con Flecha y Distancia</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.2/aframe/build/aframe-ar.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
  >
    <!-- Cámara con GPS -->
    <a-camera gps-camera rotation-reader></a-camera>

    <!-- Modelo 3D en una ubicación -->
    <a-entity
      id="modelo"
      gps-entity-place="latitude: 3.340616; longitude: -76.529395"
      gltf-model="LogoCelsiaGLB3.glb"
      scale="1 1 1"
      position="0 0 0"
    ></a-entity>

    <!-- Flecha indicadora -->
    <a-entity
      id="flecha"
      position="0 0 -2"
      geometry="primitive: cone; radiusBottom: 0.2; radiusTop: 0.0; height: 0.5"
      material="color: red"
      rotation="0 0 0"
    ></a-entity>

    <!-- Texto de distancia -->
    <a-text
      id="texto-distancia"
      value="Calculando distancia..."
      position="0 1.5 -2"
      align="center"
      color="#FFFFFF"
      width="4"
    ></a-text>
  </a-scene>

  <script>
    // Componente personalizado para actualizar la flecha y la distancia
    AFRAME.registerComponent('flecha-dinamica', {
      tick: function () {
        const cam = document.querySelector('[gps-camera]');
        const modelo = document.querySelector('#modelo');
        const flecha = document.querySelector('#flecha');
        const texto = document.querySelector('#texto-distancia');

        if (!cam.components['gps-camera'].currentCoords) return;

        const user = cam.components['gps-camera'].currentCoords;
        const objetivo = modelo.components['gps-entity-place'].attrValue;

        // Calcular distancia Haversine
        const R = 6371000; // Radio tierra en metros
        const toRad = deg => deg * Math.PI / 180;
        const dLat = toRad(objetivo.latitude - user.latitude);
        const dLon = toRad(objetivo.longitude - user.longitude);
        const lat1 = toRad(user.latitude);
        const lat2 = toRad(objetivo.latitude);

        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1) * Math.cos(lat2) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distancia = R * c;

        // Mostrar texto de distancia
        texto.setAttribute('value', `Distancia: ${distancia.toFixed(1)} m`);

        // Cambiar color si está cerca (< 20m)
        if (distancia < 20) {
          flecha.setAttribute('material', 'color: green');
        } else {
          flecha.setAttribute('material', 'color: red');
        }

        // Calcular rumbo
        const y = Math.sin(dLon) * Math.cos(lat2);
        const x = Math.cos(lat1) * Math.sin(lat2) -
                  Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
        const brng = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;

        flecha.setAttribute('rotation', `0 ${brng} 0`);
      }
    });

    // Activar comportamiento al cargar
    window.addEventListener('DOMContentLoaded', () => {
      document.querySelector('#flecha').setAttribute('flecha-dinamica', '');
    });
  </script>
</body>
</html>
